<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create components for REST API :: Talend Component Kit Developer Reference Guide</title>
    <link rel="canonical" href="https://talend.github.io/component-runtime/main/1.0.1/tutorial-create-components-rest-api.html">
    <meta name="generator" content="Antora 1.0.1">
    <link rel="stylesheet" href="../../_/css/site.css">
<meta name="date" content="2018-07-23T12:42:59.888Z" scheme="YYYY-MM-DDTHH:mm:ss.sssZ">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.css" integrity="sha256-NuCn4IvuZXdBaFKJOAcsU2Q3ZpwbdFisd5dux4jkQ5w=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/instantsearch.js/2.8.0/instantsearch.min.css" integrity="sha256-vusmcqkVvKdkwoueSJZLlO9y2P+Lp9fN3WwQUV9Uwfw=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/instantsearch.js/2.8.0/instantsearch-theme-algolia.min.css" integrity="sha256-ZqsS4QagZnfArbOyheCO4qVjzzsMbg/WMvf5tLtId/Q=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/idea.min.css" integrity="sha256-rD61BPsgKHzJPyg7vpXaYOw6tMYuY2fz1p9033NYeM8=" crossorigin="anonymous" />
<link rel="stylesheet" href="../../_/css/talend.css">
<link rel="shortcut icon" href="../../_/images/favicon_0.ico" />    <script async src="https://www.googletagmanager.com/gtag/js?id=GTM-PSBN"></script>
    <script>dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)};gtag('js',new Date());gtag('config','GTM-PSBN')</script>
  </head>
  <body class="article">
<header class="header" role="banner">
    <nav class="navbar">
        <div class="navbar-brand">
            <div class="navbar-item">
                <a href="https://talend.github.io/component-runtime">Talend Component Kit</a>
                <span class="separator">//</span>
                <a href="https://talend.github.io/component-runtime">Docs</a>
            </div>
            <button class="navbar-burger" data-target="topbar-nav">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>
        <div id="topbar-nav" class="navbar-menu">
            <div class="navbar-end">
                <div class="global-search">
                    <form role="search" action="search.html">
                        <div>
                            <input class="rounded" type="text" placeholder="Search" name="query" id="searchInput">
                            <input type="hidden" name="idx" value="githubantora">
                        </div>
                    </form>
                </div>
                <div class="navbar-item has-dropdown is-hoverable">
                    <div class="navbar-link">Projects</div>
                    <div class="navbar-dropdown">
                        <div class="navbar-item"><strong>API</strong></div>
                        <a class="navbar-item" href="https://github.com/talend/component-api">Repository</a>
                        <hr class="navbar-divider">
                        <div class="navbar-item"><strong>Runtime</strong></div>
                        <a class="navbar-item" href="https://github.com/talend/component-runtime">Repository</a>
                    </div>
                </div>
            </div>
        </div>
    </nav>
</header>
<div class="main-wrapper">
<div class="navigation-container" data-component="main" data-version="0.0.9">
  <aside class="navigation" role="navigation">
    <div class="panels">
<div class="navigation-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html">Talend Component Kit Developer Reference Guide</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
    <button class="nav-toggle"></button>
    <span class="nav-text">Programming Model</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="component-definition.html">Definition Model</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="component-configuration.html">Configuration</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="component-registering.html">Registration</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="gallery.html">Widget Gallery</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="component-internationalization.html">Labels and i18n</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-toggle"></button>
    <span class="nav-text">Package</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="component-loading.html">Loading</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-toggle"></button>
    <span class="nav-text">Build</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="build-tools-maven.html">Maven</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="build-tools-gradle.html">Gradle</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-toggle"></button>
    <span class="nav-text">Services</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="services-internationalization.html">Internationalization</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="services-actions.html">Actions</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="services-built-in.html">Built-in services</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="services-interceptors.html">Interceptors</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="services-custom-api.html">Extend the API</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-toggle"></button>
    <span class="nav-text">Execute</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="services-pipeline.html">Simple/Test Pipeline API</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="https://beam.apache.org/documentation/programming-guide/#creating-a-pipeline">Beam Pipeline API</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-toggle"></button>
    <span class="nav-text">Testing</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="testing-best-practices.html">JUnit Integration</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="testing-junit.html">Testing HTTP API</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="testing-beam.html">Beam case</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="testing-spark.html">Spark and JUnit</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="testing-multiple-envs.html">Multiple environments for the same tests</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="testing-maven-passwords.html">Secrets/Passwords and Maven</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="testing-generating-data.html">Generating data?</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-toggle"></button>
    <span class="nav-text">Web</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="documentation-rest.html">Server</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-toggle"></button>
    <span class="nav-text">Tutorials</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="tutorial-generate-project-using-starter.html">Generate a component</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="tutorial-create-an-input-component.html">Create an input component</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="tutorial-create-an-output-component.html">Create an output component</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="tutorial-test-your-components.html">Test your components</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="tutorial-configuration-sensitive-data.html">Configuration and sensitive data</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="tutorial-create-components-rest-api.html">Create components for REST API</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="tutorial-test-rest-api.html">How to test a REST API</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="tutorial-dev-vs-ci-setup.html">Dev vs CI setup</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="tutorial-talend-intellij-plugin-usage.html">Talend Intellij plugin</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="navigation-explore" data-panel="explore">
  <div class="context">
    <span class="title">Talend Component Kit Developer Reference Guide</span>
    <span class="version">0.0.9</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Talend Component Kit Developer Reference Guide</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../1.0.1/index.html">1.0.1</a>
        </li>
        <li class="version">
          <a href="../1.0.0/index.html">1.0.0</a>
        </li>
        <li class="version">
          <a href="../0.0.12/index.html">0.0.12</a>
        </li>
        <li class="version">
          <a href="../0.0.11/index.html">0.0.11</a>
        </li>
        <li class="version">
          <a href="../0.0.10/index.html">0.0.10</a>
        </li>
        <li class="version is-current">
          <a href="index.html">0.0.9</a>
        </li>
        <li class="version">
          <a href="../0.0.8/index.html">0.0.8</a>
        </li>
        <li class="version">
          <a href="../0.0.7/index.html">0.0.7</a>
        </li>
        <li class="version">
          <a href="../0.0.6/index.html">0.0.6</a>
        </li>
        <li class="version">
          <a href="../0.0.5/index.html">0.0.5</a>
        </li>
        <li class="version">
          <a href="../0.0.4/index.html">0.0.4</a>
        </li>
        <li class="version">
          <a href="../0.0.3/index.html">0.0.3</a>
        </li>
        <li class="version">
          <a href="../0.0.2/index.html">0.0.2</a>
        </li>
        <li class="version">
          <a href="../0.0.1/index.html">0.0.1</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
  <main class="main" role="main">
<div class="toolbar" role="navigation">
    <button class="navigation-toggle"></button>
    <nav class="crumbs" role="navigation" aria-label="breadcrumbs">
  <ul>
    <li class="crumb"><a href="index.html">Talend Component Kit Developer Reference Guide</a></li>
    <li class="crumb">Tutorials</li>
    <li class="crumb"><a href="tutorial-create-components-rest-api.html">Create components for REST API</a></li>
  </ul>
</nav>
    <div class="page-versions">
  <button class="versions-menu-toggle" title="Show other versions of page">0.0.9</button>
  <div class="versions-menu">
    <a class="version" href="../1.0.1/tutorial-create-components-rest-api.html">1.0.1</a>
    <a class="version" href="../1.0.0/tutorial-create-components-rest-api.html">1.0.0</a>
    <a class="version" href="../0.0.12/tutorial-create-components-rest-api.html">0.0.12</a>
    <a class="version" href="../0.0.11/tutorial-create-components-rest-api.html">0.0.11</a>
    <a class="version" href="../0.0.10/tutorial-create-components-rest-api.html">0.0.10</a>
    <a class="version is-current" href="tutorial-create-components-rest-api.html">0.0.9</a>
    <a class="version" href="../0.0.8/tutorial-create-components-rest-api.html">0.0.8</a>
    <a class="version" href="../0.0.7/tutorial-create-components-rest-api.html">0.0.7</a>
    <a class="version" href="../0.0.6/tutorial-create-components-rest-api.html">0.0.6</a>
    <a class="version" href="../0.0.5/tutorial-create-components-rest-api.html">0.0.5</a>
    <a class="version" href="../0.0.4/tutorial-create-components-rest-api.html">0.0.4</a>
    <a class="version" href="../0.0.3/tutorial-create-components-rest-api.html">0.0.3</a>
    <a class="version" href="../0.0.2/tutorial-create-components-rest-api.html">0.0.2</a>
    <a class="version is-missing" href="../0.0.1/index.html">0.0.1</a>
  </div>
</div>
</div>
<article class="doc">
        <h1>Create components for REST API</h1>
        <div id="preamble">
<div class="sectionbody">
<div id="tutorial-create-components-rest-api" class="paragraph">
<p>In this tutorial we will show how to create components that consume a REST API.</p>
</div>
<div class="paragraph">
<p>As an example, we will develop an input component that will provide a search functionality for Zendesk using there
<a href="https://developer.zendesk.com/rest_api/docs/core/search">Search API</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
We use lambok. to get ride of getters, setters and constructors from our classes.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You can generate a project using the components kit starter as described in
<a href="tutorial-generate-project-using-starter.html" class="page">this tutorial</a>.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_http_client_setup"><a class="anchor" href="#_http_client_setup"></a>1. Http client setup</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As our input component will relay on Zendesk Search API. We will need an http client to consume it.</p>
</div>
<div class="paragraph">
<p>Zendesk Search API takes the following query parameters on this endpoint <code>/api/v2/search.json</code>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>query</strong>     : The search query.</p>
</li>
<li>
<p><strong>sort_by</strong>   : One of <code>updated_at</code>, <code>created_at</code>, <code>priority</code>, <code>status</code>, or <code>ticket_type</code>. Defaults to sorting by <code>relevance</code>.</p>
</li>
<li>
<p><strong>sort_order</strong>: One of <code>asc</code> or <code>desc</code>. Defaults to <code>desc</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>So let&#8217;s create our http client according to that.</p>
</div>
<div class="paragraph">
<p>Talend component kit provides a built-in service to create an easy to use http client in a declarative manner using java annotations.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public interface SearchClient extends HttpClient { <i class="conum" data-value="1"></i><b>(1)</b>

    @Request(path = "api/v2/search.json", method = "GET") <i class="conum" data-value="2"></i><b>(2)</b>
    Response&lt;JsonObject&gt; search(@Header("Authorization") String auth,<i class="conum" data-value="3"></i><b>(3)</b> <i class="conum" data-value="4"></i><b>(4)</b>
            @Header("Content-Type") String contentType, <i class="conum" data-value="5"></i><b>(5)</b>
            @Query("query") String query, <i class="conum" data-value="6"></i><b>(6)</b>
            @Query("sort_by") String sortBy,
            @Query("sort_order") String sortOrder,
            @Query("page") Integer page
    );
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Our interface need to extend <code>org.talend.sdk.component.api.service.http.HttpClient</code>
to be known as an http client by the component framework.
This interface also provides <code>void base(String base)</code> method that will let us set the base uri for the http request. In our case, it will be the Zendesk instance url.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>@Request</code> annotation let us define two things. the http request path and method (<code>GET</code>, <code>POST</code>, <code>PUT</code>,&#8230;&#8203;).</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>At this line we have two important things. The method return type and a header param. At this point we will explain the method return
that is of type <code>Response&lt;JsonObject&gt;</code>. The <code>Response</code> object let us access
to the http response status code, headers, error payload and the response body that will be of type <code>JsonObject</code> here.
The response body will be decoded according to the content type returned by the API. The component framework provides codec for json content.
If you want to consume specific content type, you will need to provide your personalized codec using the <code>@Codec</code> annotation.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>We define the <code>Authorization</code> http request header that will let us provide the authorization token.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>We define another http request header to provide the content type.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>We define the query parameters using the <code>@Query</code> annotation that will provide the parameter name.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>And that all what we need to do to create our http client. No implementation is needed for the interface,
as it will be provided by the component framework according to what we have defined.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
This http client can be injected into a mapper or a processor to perform http requests.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_component_configuration"><a class="anchor" href="#_component_configuration"></a>2. Component Configuration</h2>
<div class="sectionbody">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
For the sake of simplicity, we will use the basic authentication supported by the API.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let&#8217;s start setting up the configuration for the basic authentication.
To be able to consume the Search API, we will need to provide the Zendesk instance URL, the username and the password.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Data
@DataStore <i class="conum" data-value="1"></i><b>(1)</b>
@GridLayout({ <i class="conum" data-value="2"></i><b>(2)</b>
        @GridLayout.Row({ "url" }),
        @GridLayout.Row({ "username", "password" })
})
@Documentation("Basic authentication for Zendesk API")
public class BasicAuth {

    @Option
    @Documentation("Zendesk instance url")
    private final String url;

    @Option
    @Documentation("Zendesk account username (e-mail).")
    private final String username;

    @Option
    @Credential <i class="conum" data-value="3"></i><b>(3)</b>
    @Documentation("Zendesk account password")
    private final String password;

    public String getAuthorizationHeader() { <i class="conum" data-value="4"></i><b>(4)</b>
        try {
            return "Basic " + Base64.getEncoder()
                    .encodeToString((this.getUsername() + ":" + this.getPassword()).getBytes("UTF-8"));
        } catch (UnsupportedEncodingException e) {
            throw new RuntimeException(e);
        }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>As This configuration class provide the authentication information. We can type it as <code>Datastore</code>,
so that it can be validated using services (a kind of <em>test connection</em> feature)
or used by Talend studio or web application metadata.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>This is the UI layout of this configuration.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We mark the password as <code>Credential</code> to that it can be handled as sensitive data in Talend Studio and web application.
<a href="tutorial-configuration-sensitive-data.html" class="page">Read more about sensitive data handling</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>This method generate a basic authentication token using the username and the password. This token will be used
to authenticate our http call to the Search API.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now that we have our data store configuration. that will provide us with the basic authentication token.
We need to setup our data set configuration.
i.e the search query that will define the records that our input component will provide.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Data
@DataSet <i class="conum" data-value="1"></i><b>(1)</b>
@GridLayout({ <i class="conum" data-value="2"></i><b>(2)</b>
        @GridLayout.Row({ "dataStore" }),
        @GridLayout.Row({ "query" }),
        @GridLayout.Row({ "sortBy", "sortOrder" })
})
@Documentation("Data set that define a search query for Zendesk Search API. See api reference https://developer.zendesk.com/rest_api/docs/core/search")
public class SearchQuery {

    @Option
    @Documentation("Authentication information.")
    private final BasicAuth dataStore;

    @Option
    @TextArea <i class="conum" data-value="3"></i><b>(3)</b>
    @Documentation("Search query.") <i class="conum" data-value="4"></i><b>(4)</b>
    private final String query;

    @Option
    @DefaultValue("relevance") <i class="conum" data-value="5"></i><b>(5)</b>
    @Documentation("One of updated_at, created_at, priority, status, or ticket_type. Defaults to sorting by relevance")
    private final String sortBy;

    @Option
    @DefaultValue("desc")
    @Documentation("One of asc or desc. Defaults to desc")
    private final String sortOrder;
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This mark this configuration class as a <code>DataSet</code> type.
<a href="component-configuration.html#_marking_a_configuration_as_a_particular_type_of_data " class="page">Read more about configuration type</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The UI layout of this configuration.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We bind a text area widget to the search query field. <a href="gallery.html" class="page">See all the available widgets</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Note the usage of <code>@Documentation</code> annotation. this annotation let us document our component (configuration in this scope).
There is a Talend component maven plugin that can be used to generate the component documentation with all the configuration description and the default values.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Here we give the field a default value.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>That&#8217;s all for the configuration part. Let&#8217;s create the component logic.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_the_component_mapper"><a class="anchor" href="#_the_component_mapper"></a>3. The component mapper</h2>
<div class="sectionbody">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
We will not split the http calls on many workers. so our mappers will not implement the split part.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Version
@Icon(value = Icon.IconType.CUSTOM, custom = "zendesk")
@PartitionMapper(name = "search")
@Documentation("Search component for zendesk query")
public class SearchMapper implements Serializable {

    private final SearchQuery configuration; <i class="conum" data-value="1"></i><b>(1)</b>
    private final SearchClient searchClient; <i class="conum" data-value="2"></i><b>(2)</b>

    public SearchMapper(@Option("configuration") final SearchQuery configuration, final SearchClient searchClient) {
        this.configuration = configuration;
        this.searchClient = searchClient;
    }

    @PostConstruct
    public void init() {
        searchClient.base(configuration.getDataStore().getUrl()); <i class="conum" data-value="3"></i><b>(3)</b>
    }

    @Assessor
    public long estimateSize() {
        return 1L;
    }

    @Split
    public List&lt;SearchMapper&gt; split(@PartitionSize final long bundles) {
        return Collections.singletonList(this); <i class="conum" data-value="4"></i><b>(4)</b>
    }

    @Emitter
    public SearchSource createWorker() {
        return new SearchSource(configuration, searchClient); <i class="conum" data-value="5"></i><b>(5)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The component configuration, that will be injected by the component framework</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The http client that we have created above. it will also be injected by the framework via the mapper constructor.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We setup the base URL of our http client using the configuration url.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>As we will not split the http requests we return this mapper in the split method.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>We create a source that will perform the http request and return the search result.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_the_component_source"><a class="anchor" href="#_the_component_source"></a>4. The component source</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now we create the source that will perform the http request to the search api and convert the result to JsonObject records.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class SearchSource implements Serializable {

    private final SearchQuery config; <i class="conum" data-value="1"></i><b>(1)</b>
    private final SearchClient searchClient; <i class="conum" data-value="2"></i><b>(2)</b>
    private BufferizedProducerSupport&lt;JsonValue&gt; bufferedReader; <i class="conum" data-value="3"></i><b>(3)</b>

    private transient int page = 0;
    private transient int previousPage = -1;

    public SearchSource(final SearchQuery configuration, final SearchClient searchClient) {
        this.config = configuration;
        this.searchClient = searchClient;
    }

    @PostConstruct
    public void init() { <i class="conum" data-value="4"></i><b>(4)</b>
        bufferedReader = new BufferizedProducerSupport&lt;&gt;(() -&gt; {
            JsonObject result = null;
            if (previousPage == -1) {
                result = search(config.getDataStore().getAuthorizationHeader(),
                        config.getQuery(), config.getSortBy(),
                        config.getSortBy() == null ? null : config.getSortOrder(), null);
            } else if (previousPage != page) {
                result = search(config.getDataStore().getAuthorizationHeader(),
                        config.getQuery(), config.getSortBy(),
                        config.getSortBy() == null ? null : config.getSortOrder(), page);
            }
            if (result == null) {
                return null;
            }
            previousPage = page;
            String nextPage = result.getString("next_page", null);
            if (nextPage != null) {
                page++;
            }

            return result.getJsonArray("results").iterator();
        });
    }

    @Producer
    public JsonObject next() { <i class="conum" data-value="5"></i><b>(5)</b>
        final JsonValue next = bufferedReader.next();
        return next == null ? null : next.asJsonObject();
    }

    <i class="conum" data-value="6"></i><b>(6)</b>
    private JsonObject search(String auth, String query, String sortBy, String sortOrder, Integer page) {
        final Response&lt;JsonObject&gt; response = searchClient.search(auth, "application/json",
                query, sortBy, sortOrder, page);
        if (response.status() == 200 &amp;&amp; response.body().getInt("count") != 0) {
            return response.body();
        }

        final String mediaType = extractMediaType(response.headers());
        if (mediaType != null &amp;&amp; mediaType.contains("application/json")) {
            final JsonObject error = response.error(JsonObject.class);
            throw new RuntimeException(error.getString("error") + "\n" + error.getString("description"));
        }
        throw new RuntimeException(response.error(String.class));
    }

    <i class="conum" data-value="7"></i><b>(7)</b>
    private String extractMediaType(final Map&lt;String, List&lt;String&gt;&gt; headers) {
        final String contentType = headers == null || headers.isEmpty()
                || !headers.containsKey(HEADER_Content_Type) ? null :
                headers.get(HEADER_Content_Type).iterator().next();

        if (contentType == null || contentType.isEmpty()) {
            return null;
        }
        // content-type contains charset and/or boundary
        return ((contentType.contains(";")) ? contentType.split(";")[0] : contentType).toLowerCase(ROOT);
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The component configuration injected from the component mapper.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The http client injected from the component mapper.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>A buffer utility that we will use to buffer search result and iterate on theme one by one</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>In the init method we initialize our record buffer by providing the logic to iterate on the search result.
we get the first result page and convert the results to json records. The buffer will retrieve the next result page if needed.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>This method return the next record from the buffer. when no more record is present the buffer return <code>null</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>In this method we use the http client to perform the http request to the search api.
According to the http response status code we get get the results or we throw an error if needed.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>This method let us extract the media type returned by the API.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>That all you will need to do to create a simple Talend component that consume a REST API.</p>
</div>
<div class="paragraph">
<p>In a next tutorial, we will show how to test this kind of component and use the component framework API simulation tools
to create unit tests.</p>
</div>
</div>
</div>
    </article>
  </main>
</div>
<footer class="footer">
    <div class="footer-with-copyright footer-with-links">
        <ul class="footer-links" style="">
            <li><a class="gwt-Anchor" href="http://www.talend.com/">Talend</a></li>
            <li><a class="gwt-Anchor" href="http://www.talend.com/contact">Contact</a></li>
            <li><a class="gwt-Anchor" href="http://www.talend.com/legal-terms/us-eula">Talend EULA</a></li>
        </ul>
        <div class="footer-copyright" style="">&copy; 2018 Talend Inc. All rights reserved.</div>
    </div>
</footer>
<script src="../../_/js/site.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js" integrity="sha256-/BfiIkHlHoVihZdc6TFuj7MmJ0TWcWsMXkeDFwhi0zw=" crossorigin="anonymous"></script>
<script>
(function (window, document) {
  hljs.initHighlighting();

  var closedSize = '50px';
  document.querySelectorAll('.listingblock')
    .forEach(function (listingblock, index) {
      var pre = listingblock.querySelector('div.content > pre.highlightjs.highlight');
      if (!pre) {return;}
      var code = pre.querySelector('code.hljs');
      if (!code) {return;}

      var span = document.createElement('span');
      var initialBlockClosed = listingblock.className.indexOf('initial-block-closed') >= 0;
      span.className = 'code-' + (initialBlockClosed ? 'collapsed' : 'open') + '-handle code-handle-base';

      var height = code.style.height;
      if (initialBlockClosed) {code.style.height = closedSize;}

      span.addEventListener('click', function () {
        if (span.className == 'code-collapsed-handle code-handle-base') {
          code.style.height = height;
          span.className = 'code-open-handle code-handle-base';
        } else {
          code.style.height = closedSize;
          span.className = 'code-collapsed-handle code-handle-base';
        }
      }, false);

      pre.prepend(span);
    });
})(window, document);
</script>
  </body>
</html>
